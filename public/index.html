<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudX - Personal Cloud</title>
    <link rel="icon" href="/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 32px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-google {
            background: #db4437;
            color: white;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-google:hover {
            background: #c53929;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input,
        select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .file-item {
            padding: 20px;
            background: white;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .file-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            background: #10b981;
            color: white;
        }

        .message.error {
            background: #ef4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
        }

        .storage-widget {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div>
                <h1>‚òÅÔ∏è CloudX</h1>
                <p style="color: #666; font-size: 14px;">Your Personal Cloud</p>
            </div>
            <div id="authSection">
                <button class="btn btn-primary" onclick="showLogin()" id="loginBtn">üîê Login</button>
                <div class="user-profile" id="userProfile" style="display:none;">
                    <div class="avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div id="userName" style="font-weight:600;"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <!-- Storage Widget -->
        <div class="storage-widget" id="storageWidget" style="display:none;">
            <h3 style="margin-bottom:10px;">üíæ Storage Usage</h3>
            <div style="display:flex; justify-content:space-between; font-size:14px;">
                <span id="usedSpace">0 GB</span>
                <span id="totalSpace">0 GB</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('files')">üìÅ Files</button>
            <button class="tab" onclick="switchTab('database')">üóÑÔ∏è Database</button>
            <button class="tab" onclick="switchTab('apikeys')">üîë API Keys</button>
        </div>

        <!-- Files Tab -->
        <div id="files" class="tab-content active">
            <div class="card">
                <div class="form-group">
                    <select id="bucketSelect" onchange="loadFiles()">
                        <option value="">Select bucket...</option>
                    </select>
                    <button class="btn btn-primary" onclick="createBucket()">+ Bucket</button>
                    <button class="btn btn-primary" onclick="createFolder()">üìÅ Folder</button>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì§
                        Upload</button>
                    <input type="file" id="fileInput" style="display:none" multiple onchange="uploadFiles()">
                </div>
                <div id="breadcrumb" style="margin:10px 0; color:#666;"></div>
                <div id="fileList" class="file-grid"></div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom:15px;">Create Database</h2>
                <div class="form-group">
                    <input type="text" id="dbName" placeholder="Database name">
                    <button class="btn btn-primary" onclick="createDB()">Create</button>
                </div>
            </div>
            <div class="card">
                <h2 style="margin-bottom:15px;">SQL Query</h2>
                <textarea id="sqlQuery" placeholder="SELECT * FROM table_name"
                    style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; min-height:100px; font-family:monospace;"></textarea>
                <button class="btn btn-primary" onclick="executeSQL()" style="margin-top:10px;">Execute</button>
                <div id="queryResults" style="margin-top:15px; overflow-x:auto;"></div>
            </div>
            <div class="card">
                <h2 style="margin-bottom:15px;">Databases</h2>
                <div id="dbList"></div>
            </div>
        </div>

        <!-- API Keys Tab -->
        <div id="apikeys" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom:15px;">Generate API Key</h2>
                <div class="form-group">
                    <input type="text" id="keyName" placeholder="Key name">
                    <button class="btn btn-primary" onclick="generateKey()">Generate</button>
                </div>
                <div id="newKey"
                    style="display:none; margin-top:15px; padding:15px; background:#f0f8ff; border-radius:8px;">
                    <p style="font-weight:600; margin-bottom:10px;">‚ö†Ô∏è Save this key!</p>
                    <code id="keyValue"
                        style="display:block; padding:10px; background:white; border-radius:4px; word-break:break-all; font-size:12px;"></code>
                </div>
            </div>
            <div class="card">
                <h2 style="margin-bottom:15px;">API Keys</h2>
                <div id="keyList"></div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#667eea; margin-bottom:25px; text-align:center;">Login to CloudX</h2>

            <button class="btn btn-google" onclick="loginGoogle()">
                <span style="margin-right:10px;">G</span> Sign in with Google
            </button>

            <div style="display:flex; align-items:center; margin:20px 0;">
                <div style="flex:1; height:1px; background:#ddd;"></div>
                <div style="padding:0 10px; color:#666; font-size:14px;">OR</div>
                <div style="flex:1; height:1px; background:#ddd;"></div>
            </div>

            <div style="margin-bottom:20px;">
                <h3 style="font-size:16px; margin-bottom:12px;">Admin Access</h3>
                <input type="password" id="masterKey" placeholder="Enter master key"
                    style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; margin-bottom:10px;">
                <button class="btn btn-primary" style="width:100%;" onclick="loginAdmin()">Login as Admin</button>
            </div>
            <button class="btn" style="width:100%; background:#f5f5f5;" onclick="closeLogin()">Cancel</button>
        </div>
    </div>

    <div id="message" class="message"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDOCAbC123dEf456GhI789jKl012MnO", // Replace with your actual config from Firebase Console
            authDomain: "cloudx-e928c.firebaseapp.com",
            projectId: "cloudx-e928c",
            storageBucket: "cloudx-e928c.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.loginGoogle = async function () {
            try {
                const result = await signInWithPopup(auth, provider);
                const idToken = await result.user.getIdToken();

                // Send to backend
                const res = await fetch('https://cloudx-api.onrender.com/api/v1/auth/google-signin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken })
                });

                if (!res.ok) throw new Error('Backend auth failed');

                const data = await res.json();
                localStorage.setItem('cloudx_auth', data.apiKey);
                window.location.reload();
            } catch (error) {
                console.error('Google login error:', error);
                alert('Login failed: ' + error.message);
            }
        };
    </script>

    <script>
        const API = 'https://cloudx-api.onrender.com/api/v1';
        const MASTER_KEY = 'cloudx-admin-2024-secure-key';
        let apiKey = localStorage.getItem('cloudx_auth');
        let currentBucket = '';
        let currentFolder = '';
        let userProfile = null;

        // Auth
        function showLogin() { document.getElementById('loginModal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }

        async function loginAdmin() {
            const key = document.getElementById('masterKey').value;
            if (key === MASTER_KEY) {
                apiKey = key;
                localStorage.setItem('cloudx_auth', key);
                closeLogin();
                await loadProfile();
                showMsg('‚úÖ Admin access granted!', 'success');
            } else {
                showMsg('‚ùå Invalid key!', 'error');
            }
        }

        async function loadProfile() {
            try {
                const res = await fetch(`${API}/auth/profile`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!res.ok) throw new Error('Profile load failed');
                userProfile = await res.json();

                // Update UI
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'flex';
                document.getElementById('userName').textContent = userProfile.name;
                document.getElementById('userEmail').textContent = userProfile.email;
                document.getElementById('userAvatar').textContent = userProfile.name[0].toUpperCase();
                document.getElementById('storageWidget').style.display = 'block';

                loadBuckets();
                loadDatabases();
                loadKeys();
                loadStorageStats();
            } catch (err) {
                console.error('Profile load error:', err);
                if (apiKey) logout(); // Invalid key
            }
        }

        function logout() {
            localStorage.removeItem('cloudx_auth');
            apiKey = null;
            userProfile = null;
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('userProfile').style.display = 'none';
            document.getElementById('storageWidget').style.display = 'none';
            showMsg('Logged out', 'success');
        }

        // UI
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function showMsg(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message show ${type}`;
            setTimeout(() => msg.classList.remove('show'), 3000);
        }

        // Storage Stats
        async function loadStorageStats() {
            try {
                const res = await fetch(`${API}/storage/stats`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const stats = await res.json();
                const usedGB = (stats.used / 1024 / 1024 / 1024).toFixed(2);
                const totalGB = (stats.total / 1024 / 1024 / 1024).toFixed(2);
                const percent = ((stats.used / stats.total) * 100).toFixed(1);

                document.getElementById('usedSpace').textContent = `${usedGB} GB used`;
                document.getElementById('totalSpace').textContent = `${totalGB} GB total`;
                document.getElementById('progressFill').style.width = `${percent}%`;
            } catch (err) {
                console.error('Storage stats error:', err);
            }
        }

        // Files
        async function loadBuckets() {
            try {
                const res = await fetch(`${API}/storage/buckets`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const buckets = await res.json();
                const select = document.getElementById('bucketSelect');
                select.innerHTML = '<option value="">Select bucket...</option>';
                Object.keys(buckets).forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
            } catch (err) {
                showMsg('Error loading buckets', 'error');
            }
        }

        async function loadFiles() {
            currentBucket = document.getElementById('bucketSelect').value;
            if (!currentBucket) {
                document.getElementById('fileList').innerHTML = '<p style="text-align:center; padding:40px; color:#666;">Select a bucket</p>';
                return;
            }
            try {
                const res = await fetch(`${API}/storage/buckets/${currentBucket}/browse?folder=${currentFolder}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const data = await res.json();
                displayFiles(data.items || []);
            } catch (err) {
                showMsg('Error loading files', 'error');
            }
        }

        function displayFiles(items) {
            const list = document.getElementById('fileList');
            if (!items.length) {
                list.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">üìÇ Empty folder</p>';
                return;
            }
            list.innerHTML = items.map(item => `
                <div class="file-item" onclick="handleClick('${item.name}', '${item.type}')" style="position:relative;">
                    <div class="file-icon">${item.type === 'folder' ? 'üìÅ' : 'üìÑ'}</div>
                    <div style="font-weight:600; font-size:14px;">${item.name}</div>
                    ${item.type === 'file' ? `
                    <button onclick="event.stopPropagation(); downloadFile('${item.name}')" 
                            style="position:absolute; top:10px; right:10px; background:rgba(102,126,234,0.1); border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                        üì•
                    </button>` : ''}
                </div>
            `).join('');
        }

        async function downloadFile(filename) {
            if (!currentBucket) return;
            const folder = currentFolder ? `?folder=${currentFolder}` : '';
            const url = `${API}/storage/${currentBucket}/download/${filename}${folder}`;

            try {
                const res = await fetch(url, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!res.ok) throw new Error('Download failed');

                const blob = await res.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
            } catch (err) {
                showMsg('Download failed: ' + err.message, 'error');
            }
        }

        function handleClick(name, type) {
            if (type === 'folder') {
                currentFolder = currentFolder ? `${currentFolder}/${name}` : name;
                loadFiles();
            }
        }

        async function createBucket() {
            const name = prompt('Bucket name:');
            if (!name) return;
            try {
                await fetch(`${API}/storage/buckets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ name })
                });
                showMsg('‚úÖ Bucket created!', 'success');
                loadBuckets();
            } catch (err) {
                showMsg('‚ùå Error creating bucket', 'error');
            }
        }

        async function createFolder() {
            if (!currentBucket) return showMsg('Select a bucket first', 'error');
            const name = prompt('Folder name:');
            if (!name) return;
            const folderPath = currentFolder ? `${currentFolder}/${name}` : name;
            try {
                await fetch(`${API}/storage/buckets/${currentBucket}/folders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ folderPath })
                });
                showMsg('‚úÖ Folder created!', 'success');
                loadFiles();
            } catch (err) {
                showMsg('‚ùå Error creating folder', 'error');
            }
        }

        async function uploadFiles() {
            if (!currentBucket) return showMsg('Select a bucket first', 'error');
            const files = document.getElementById('fileInput').files;
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', currentFolder);
                try {
                    await fetch(`${API}/storage/${currentBucket}/upload`, {
                        method: 'POST',
                        headers: { 'X-API-Key': apiKey },
                        body: formData
                    });
                    showMsg(`‚úÖ ${file.name} uploaded!`, 'success');
                } catch (err) {
                    showMsg(`‚ùå Error uploading ${file.name}`, 'error');
                }
            }
            loadFiles();
            loadStorageStats();
        }

        // Database
        async function loadDatabases() {
            try {
                const res = await fetch(`${API}/database/databases`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const dbs = await res.json();
                const list = document.getElementById('dbList');
                list.innerHTML = Object.keys(dbs).map(name => `
                    <div style="padding:15px; background:white; border-radius:8px; margin-bottom:10px;">
                        <strong>${name}</strong>
                        <span style="color:#666; font-size:12px; margin-left:10px;">${dbs[name].engine}</span>
                    </div>
                `).join('') || '<p style="color:#666; padding:15px;">No databases yet</p>';
            } catch (err) {
                showMsg('Error loading databases', 'error');
            }
        }

        async function createDB() {
            const name = document.getElementById('dbName').value;
            if (!name) return showMsg('Enter database name', 'error');
            try {
                await fetch(`${API}/database/databases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ name, engine: 'sqlite' })
                });
                showMsg('‚úÖ Database created!', 'success');
                document.getElementById('dbName').value = '';
                loadDatabases();
            } catch (err) {
                showMsg('‚ùå Error creating database', 'error');
            }
        }

        async function executeSQL() {
            const query = document.getElementById('sqlQuery').value;
            if (!query) return showMsg('Enter SQL query', 'error');

            // Get first database for now (TODO: Add DB selector)
            const dbList = document.getElementById('dbList');
            if (!dbList.children.length) return showMsg('Create a database first', 'error');
            const dbName = dbList.children[0].querySelector('strong').textContent;

            try {
                const res = await fetch(`${API}/database/databases/${dbName}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Display results
                const resultsDiv = document.getElementById('queryResults');
                if (data.results && data.results.length > 0) {
                    const cols = Object.keys(data.results[0]);
                    resultsDiv.innerHTML = `
                        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                            <thead>
                                <tr style="background:#f0f0f0;">
                                    ${cols.map(c => `<th style="padding:8px; border:1px solid #ddd;">${c}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(row => `
                                    <tr>
                                        ${cols.map(c => `<td style="padding:8px; border:1px solid #ddd;">${row[c]}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    resultsDiv.innerHTML = '<p style="color:#666; padding:10px;">No results or empty result set</p>';
                }
                showMsg('‚úÖ Query executed!', 'success');
            } catch (err) {
                showMsg('‚ùå SQL Error: ' + err.message, 'error');
            }
        }

        // API Keys
        async function loadKeys() {
            try {
                const res = await fetch(`${API}/auth/keys`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const keys = await res.json();
                const list = document.getElementById('keyList');
                list.innerHTML = keys.map(k => `
                    <div style="padding:15px; background:white; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${k.name || 'Unnamed'}</strong>
                            <div style="font-size:12px; color:#666;">${k.keyPrefix}</div>
                        </div>
                        <button class="btn btn-danger" style="padding:6px 12px; font-size:12px;" onclick="revokeKey('${k.keyPrefix}')">Revoke</button>
                    </div>
                `).join('') || '<p style="color:#666; padding:15px;">No API keys yet</p>';
            } catch (err) {
                showMsg('Error loading keys', 'error');
            }
        }

        async function generateKey() {
            const name = document.getElementById('keyName').value;
            if (!name) return showMsg('Enter key name', 'error');
            try {
                const res = await fetch(`${API}/auth/keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                    body: JSON.stringify({ name })
                });
                const data = await res.json();
                document.getElementById('keyValue').textContent = data.key;
                document.getElementById('newKey').style.display = 'block';
                document.getElementById('keyName').value = '';
                showMsg('‚úÖ API key generated!', 'success');
                loadKeys();
            } catch (err) {
                showMsg('‚ùå Error generating key', 'error');
            }
        }

        async function revokeKey(keyPrefix) {
            if (!confirm('Revoke this key?')) return;
            try {
                await fetch(`${API}/auth/keys/${keyPrefix}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });
                showMsg('‚úÖ Key revoked!', 'success');
                loadKeys();
            } catch (err) {
                showMsg('‚ùå Error revoking key', 'error');
            }
        }

        // Init
        if (apiKey) {
            loadProfile();
        }
    </script>
</body>

</html>